import fs from 'fs';
import readline from 'readline';

export default class ReadlineStrategy {

  constructor({file, line}){
    this.file = file;
    this.line = line;
  }

  async initialize(){
    this.system = readline.createInterface({
      input: fs.createReadStream(this.file),
      crlfDelay: Infinity
    });
    this.system.on('line', this.line);
  }

  async dispatch(action){
    if(!action) return;
    
    const payload = JSON.stringify(action)+'\n';
    fs.appendFile(this.file, payload, (error) => {
      // this will _NOT_ trigger tail on line... hence the .write below
      if (error) console.error(error);
    });
    // must manually trigger a write.
    this.system.write(payload);
  }

}
